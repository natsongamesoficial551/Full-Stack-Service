name: ğŸš€ Atualizar IA Automaticamente

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  atualizar-ia:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v3
      
      - name: â³ Aguardar deploy do Netlify (AUMENTADO)
        run: |
          echo "â³ Aguardando Netlify fazer deploy completo..."
          echo "ğŸ“Œ Tempo de espera: 2 minutos (120 segundos)"
          sleep 120
          echo "âœ… Deploy do Netlify deve estar concluÃ­do!"
      
      - name: ğŸ” Verificar se site estÃ¡ acessÃ­vel
        run: |
          echo "ğŸ” Verificando acesso ao site..."
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://natansites.com.br/promocao_relampago.html)
          echo "Status HTTP: $STATUS"
          
          if [ "$STATUS" -eq 200 ]; then
            echo "âœ… Site estÃ¡ acessÃ­vel!"
          else
            echo "âš ï¸ Site retornou cÃ³digo $STATUS - continuando mesmo assim..."
          fi
      
      - name: ğŸ”„ Chamar webhook de atualizaÃ§Ã£o
        id: webhook
        run: |
          echo "ğŸ“¡ Chamando webhook de atualizaÃ§Ã£o da IA..."
          echo "ğŸ”‘ Usando WEBHOOK_SECRET configurado"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://natansites.com.br/.netlify/functions/atualizar-ia \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 90)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESPOSTA DO WEBHOOK:"
          echo "Status HTTP: $HTTP_CODE"
          echo "Corpo: $BODY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Webhook chamado com sucesso!"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Webhook retornou cÃ³digo $HTTP_CODE"
            echo "status=warning" >> $GITHUB_OUTPUT
            exit 0
          fi
      
      - name: â° Aguardar processamento completo
        if: steps.webhook.outputs.status == 'success'
        run: |
          echo "â° Aguardando processamento completo..."
          echo "ğŸ“Œ Tempo total: 3 minutos"
          echo ""
          echo "O que estÃ¡ acontecendo agora:"
          echo "  1. âœ… Scraping das pÃ¡ginas do site"
          echo "  2. âœ… ImportaÃ§Ã£o do repositÃ³rio GitHub"
          echo "  3. âœ… Salvamento no Supabase"
          echo "  4. â³ Aguardando cache do backend atualizar (atÃ© 5 min)"
          echo ""
          sleep 180
          echo "âœ… Processamento deve estar completo!"
      
      - name: ğŸ§¹ Limpar cache antigo (NOVO)
        if: steps.webhook.outputs.status == 'success'
        continue-on-error: true
        run: |
          echo "ğŸ§¹ ForÃ§ando atualizaÃ§Ã£o do cache..."
          curl -X POST \
            https://natanai-dev.onrender.com/atualizar_cache \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 30 || echo "âš ï¸ Falha ao limpar cache (nÃ£o crÃ­tico)"
      
      - name: âœ… AtualizaÃ§Ã£o concluÃ­da
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PROCESSO CONCLUÃDO COM SUCESSO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Resumo:"
          echo "  âœ… GitHub atualizado"
          echo "  âœ… Netlify fez deploy (120s aguardados)"
          echo "  âœ… Site verificado e acessÃ­vel"
          echo "  âœ… Webhook executado com sucesso"
          echo "  âœ… Cache forÃ§ado a atualizar"
          echo "  â³ IA serÃ¡ atualizada em atÃ© 5 minutos"
          echo ""
          echo "ğŸ” Para verificar se atualizou:"
          echo "  1. Acesse: https://natansites.com.br/promocao_relampago.html"
          echo "  2. Verifique o conteÃºdo da pÃ¡gina"
          echo "  3. Pergunte Ã  IA sobre promoÃ§Ãµes"
          echo "  4. Compare a resposta com o HTML atual"
          echo ""
          echo "ğŸ†˜ Se nÃ£o funcionar:"
          echo "  - Verifique logs em: GitHub Actions"
          echo "  - Teste manualmente: POST /atualizar_cache"
          echo "  - Confira Supabase: tabela 'site_content'"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"