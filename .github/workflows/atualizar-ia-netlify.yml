name: ğŸš€ Atualizar IA Automaticamente

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite rodar manualmente tambÃ©m

jobs:
  atualizar-ia:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v3
      
      - name: â³ Aguardar deploy do Netlify
        run: |
          echo "â³ Aguardando Netlify fazer deploy (90 segundos)..."
          sleep 90
          echo "âœ… Deploy do Netlify deve estar concluÃ­do!"
      
      - name: ğŸ”„ Chamar webhook de atualizaÃ§Ã£o
        id: webhook
        run: |
          echo "ğŸ“¡ Chamando webhook de atualizaÃ§Ã£o da IA..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://natansites.com.br/.netlify/functions/atualizar-ia \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Status HTTP: $HTTP_CODE"
          echo "Resposta: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Webhook chamado com sucesso!"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Webhook retornou cÃ³digo $HTTP_CODE"
            echo "status=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: â° Aguardar cache do backend atualizar
        if: steps.webhook.outputs.status == 'success'
        run: |
          echo "â° Aguardando cache do backend atualizar (atÃ© 5 minutos)..."
          echo "ğŸ’¡ A IA comeÃ§arÃ¡ a responder com dados novos em breve!"
      
      - name: âœ… AtualizaÃ§Ã£o concluÃ­da
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PROCESSO CONCLUÃDO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Status:"
          echo "  âœ… GitHub atualizado"
          echo "  âœ… Netlify fez deploy"
          echo "  âœ… Webhook foi chamado"
          echo "  â³ IA serÃ¡ atualizada em atÃ© 5 minutos"
          echo ""
          echo "ğŸ” Para verificar se atualizou:"
          echo "  - Rode: ./verificar-supabase.ps1"
          echo "  - Ou pergunte algo pra IA e veja se responde com dados novos"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"