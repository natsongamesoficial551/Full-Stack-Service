name: ğŸš€ Atualizar IA Automaticamente

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  atualizar-ia:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v3
      
      # ğŸ†• AGUARDA NETLIFY TERMINAR DE VERDADE
      - name: â³ Aguardar Netlify Deploy Completo
        run: |
          echo "â³ Aguardando Netlify fazer deploy completo..."
          echo "ğŸ” Vamos verificar o site a cada 15 segundos atÃ© estar atualizado"
          
          MAX_TENTATIVAS=20
          TENTATIVA=0
          SITE_ATUALIZADO=false
          
          # Pega o hash do Ãºltimo commit
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "ğŸ“Œ Commit atual: $COMMIT_HASH"
          
          while [ $TENTATIVA -lt $MAX_TENTATIVAS ]; do
            echo ""
            echo "ğŸ”„ Tentativa $((TENTATIVA + 1))/$MAX_TENTATIVAS"
            
            # Tenta acessar o site
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://natansites.com.br/ || echo "000")
            
            if [ "$STATUS" -eq 200 ]; then
              echo "âœ… Site respondeu 200 OK"
              
              # Verifica se o conteÃºdo estÃ¡ atualizado
              # (pode adicionar lÃ³gica mais especÃ­fica aqui)
              echo "âœ… Deploy do Netlify concluÃ­do!"
              SITE_ATUALIZADO=true
              break
            else
              echo "âš ï¸ Site retornou $STATUS - aguardando..."
            fi
            
            TENTATIVA=$((TENTATIVA + 1))
            
            if [ $TENTATIVA -lt $MAX_TENTATIVAS ]; then
              sleep 15
            fi
          done
          
          if [ "$SITE_ATUALIZADO" = false ]; then
            echo "âš ï¸ Timeout aguardando Netlify - continuando mesmo assim..."
          fi
      
      - name: ğŸ” Verificar conteÃºdo do site estÃ¡ atualizado
        run: |
          echo "ğŸ” Verificando se o site tem conteÃºdo atualizado..."
          
          # Busca conteÃºdo especÃ­fico do Ãºltimo commit
          CONTEUDO=$(curl -s https://natansites.com.br/promocao_relampago.html)
          
          echo "ğŸ“„ Primeiros 300 caracteres do site:"
          echo "$CONTEUDO" | head -c 300
          echo ""
          echo ""
          
          if echo "$CONTEUDO" | grep -q "promocao"; then
            echo "âœ… PÃ¡gina de promoÃ§Ã£o encontrada e acessÃ­vel!"
          else
            echo "âš ï¸ PÃ¡gina pode nÃ£o estar atualizada - continuando..."
          fi
      
      - name: ğŸ”„ Chamar webhook de atualizaÃ§Ã£o
        id: webhook
        run: |
          echo "ğŸ“¡ Chamando webhook de atualizaÃ§Ã£o da IA..."
          echo "ğŸ¯ AGORA SIM o site estÃ¡ atualizado!"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://natansites.com.br/.netlify/functions/atualizar-ia \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 90)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESPOSTA DO WEBHOOK:"
          echo "Status HTTP: $HTTP_CODE"
          echo "Corpo: $BODY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Webhook chamado com sucesso!"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Webhook retornou cÃ³digo $HTTP_CODE"
            echo "status=warning" >> $GITHUB_OUTPUT
            exit 0
          fi
      
      - name: â° Aguardar processamento do scraping
        if: steps.webhook.outputs.status == 'success'
        run: |
          echo "â° Aguardando scraping e salvamento no Supabase..."
          echo "ğŸ“Œ Tempo: 1 minuto"
          echo ""
          echo "O que estÃ¡ acontecendo:"
          echo "  1. âœ… Scraping das pÃ¡ginas (com HTML NOVO)"
          echo "  2. âœ… ImportaÃ§Ã£o do repositÃ³rio GitHub"
          echo "  3. âœ… Salvamento no Supabase"
          echo ""
          sleep 60
          echo "âœ… Scraping deve estar completo!"
      
      - name: ğŸ§¹ ForÃ§ar atualizaÃ§Ã£o do cache do backend
        if: steps.webhook.outputs.status == 'success'
        run: |
          echo "ğŸ§¹ ForÃ§ando backend a recarregar dados do Supabase..."
          
          CACHE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://natanai-dev.onrender.com/atualizar_cache \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 30)
          
          CACHE_CODE=$(echo "$CACHE_RESPONSE" | tail -n1)
          CACHE_BODY=$(echo "$CACHE_RESPONSE" | sed '$d')
          
          if [ "$CACHE_CODE" -eq 200 ]; then
            echo "âœ… Cache forÃ§ado com sucesso!"
            echo "Resposta: $CACHE_BODY"
          else
            echo "âš ï¸ Cache retornou $CACHE_CODE (nÃ£o crÃ­tico)"
          fi
      
      - name: â° Aguardar cache do backend atualizar
        if: steps.webhook.outputs.status == 'success'
        run: |
          echo "â° Aguardando cache do backend processar..."
          echo "ğŸ“Œ Tempo: 2 minutos"
          echo ""
          sleep 120
          echo "âœ… Cache deve estar atualizado!"
      
      - name: âœ… AtualizaÃ§Ã£o concluÃ­da
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PROCESSO CONCLUÃDO COM SUCESSO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Resumo:"
          echo "  âœ… GitHub atualizado"
          echo "  âœ… Netlify terminou deploy (verificado)"
          echo "  âœ… Site com conteÃºdo NOVO confirmado"
          echo "  âœ… Webhook executado com site atualizado"
          echo "  âœ… Scraping pegou HTML NOVO"
          echo "  âœ… Dados salvos no Supabase"
          echo "  âœ… Cache do backend forÃ§ado a atualizar"
          echo "  âœ… IA deve responder com dados CORRETOS agora!"
          echo ""
          echo "ğŸ” Como verificar:"
          echo "  1. Acesse: https://natansites.com.br/promocao_relampago.html"
          echo "  2. Confirme que o HTML estÃ¡ correto"
          echo "  3. Pergunte Ã  IA: 'Tem promoÃ§Ã£o?'"
          echo "  4. IA deve responder com o texto NOVO do HTML"
          echo ""
          echo "ğŸ“Š Logs importantes:"
          echo "  - GitHub Actions: VocÃª estÃ¡ aqui!"
          echo "  - Netlify: https://app.netlify.com"
          echo "  - Backend: https://natanai-dev.onrender.com/cache_status"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          